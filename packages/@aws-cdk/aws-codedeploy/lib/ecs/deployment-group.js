"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.EcsDeploymentGroup = void 0;
const jsiiDeprecationWarnings = require("../../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const ecs = require("@aws-cdk/aws-ecs");
const iam = require("@aws-cdk/aws-iam");
const cdk = require("@aws-cdk/core");
const cx_api_1 = require("@aws-cdk/cx-api");
const constructs_1 = require("constructs");
const application_1 = require("./application");
const deployment_config_1 = require("./deployment-config");
const codedeploy_generated_1 = require("../codedeploy.generated");
const base_deployment_group_1 = require("../private/base-deployment-group");
const utils_1 = require("../private/utils");
/**
 * A CodeDeploy deployment group that orchestrates ECS blue-green deployments.
 * @resource AWS::CodeDeploy::DeploymentGroup
 */
class EcsDeploymentGroup extends base_deployment_group_1.DeploymentGroupBase {
    constructor(scope, id, props) {
        super(scope, id, {
            deploymentGroupName: props.deploymentGroupName,
            role: props.role,
            roleConstructId: 'ServiceRole',
        });
        try {
            jsiiDeprecationWarnings._aws_cdk_aws_codedeploy_EcsDeploymentGroupProps(props);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, EcsDeploymentGroup);
            }
            throw error;
        }
        this.role = this._role;
        this.application = props.application || new application_1.EcsApplication(this, 'Application');
        this.alarms = props.alarms || [];
        this.role.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('AWSCodeDeployRoleForECS'));
        this.deploymentConfig = this._bindDeploymentConfig(props.deploymentConfig || deployment_config_1.EcsDeploymentConfig.ALL_AT_ONCE);
        if (cdk.Resource.isOwnedResource(props.service)) {
            const cfnSvc = props.service.node.defaultChild;
            if (cfnSvc.deploymentController === undefined ||
                cfnSvc.deploymentController.type !== ecs.DeploymentControllerType.CODE_DEPLOY) {
                throw new Error('The ECS service associated with the deployment group must use the CODE_DEPLOY deployment controller type');
            }
            if (cfnSvc.taskDefinition !== props.service.taskDefinition.family) {
                throw new Error('The ECS service associated with the deployment group must specify the task definition using the task definition family name only. Otherwise, the task definition cannot be updated in the stack');
            }
        }
        const removeAlarmsFromDeploymentGroup = cdk.FeatureFlags.of(this).isEnabled(cx_api_1.CODEDEPLOY_REMOVE_ALARMS_FROM_DEPLOYMENT_GROUP);
        const resource = new codedeploy_generated_1.CfnDeploymentGroup(this, 'Resource', {
            applicationName: this.application.applicationName,
            serviceRoleArn: this.role.roleArn,
            deploymentGroupName: this.physicalName,
            deploymentConfigName: this.deploymentConfig.deploymentConfigName,
            deploymentStyle: {
                deploymentType: 'BLUE_GREEN',
                deploymentOption: 'WITH_TRAFFIC_CONTROL',
            },
            ecsServices: [{
                    clusterName: props.service.cluster.clusterName,
                    serviceName: props.service.serviceName,
                }],
            blueGreenDeploymentConfiguration: cdk.Lazy.any({
                produce: () => this.renderBlueGreenDeploymentConfiguration(props.blueGreenDeploymentConfig),
            }),
            loadBalancerInfo: cdk.Lazy.any({ produce: () => this.renderLoadBalancerInfo(props.blueGreenDeploymentConfig) }),
            alarmConfiguration: cdk.Lazy.any({
                produce: () => utils_1.renderAlarmConfiguration(this.alarms, props.ignorePollAlarmsFailure, removeAlarmsFromDeploymentGroup),
            }),
            autoRollbackConfiguration: cdk.Lazy.any({ produce: () => utils_1.renderAutoRollbackConfiguration(this.alarms, props.autoRollback) }),
        });
        this._setNameAndArn(resource, this.application);
        // If the deployment config is a construct, add a dependency to ensure the deployment config
        // is created before the deployment group is.
        if (constructs_1.Construct.isConstruct(this.deploymentConfig)) {
            this.node.addDependency(this.deploymentConfig);
        }
    }
    /**
     * Reference an ECS Deployment Group defined outside the CDK app.
     *
     * Account and region for the DeploymentGroup are taken from the application.
     *
     * @param scope the parent Construct for this new Construct
     * @param id the logical ID of this new Construct
     * @param attrs the properties of the referenced Deployment Group
     * @returns a Construct representing a reference to an existing Deployment Group
     */
    static fromEcsDeploymentGroupAttributes(scope, id, attrs) {
        try {
            jsiiDeprecationWarnings._aws_cdk_aws_codedeploy_EcsDeploymentGroupAttributes(attrs);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.fromEcsDeploymentGroupAttributes);
            }
            throw error;
        }
        return new ImportedEcsDeploymentGroup(scope, id, attrs);
    }
    /**
     * Associates an additional alarm with this Deployment Group.
     *
     * @param alarm the alarm to associate with this Deployment Group
     */
    addAlarm(alarm) {
        this.alarms.push(alarm);
    }
    renderBlueGreenDeploymentConfiguration(options) {
        return {
            deploymentReadyOption: {
                actionOnTimeout: options.deploymentApprovalWaitTime ? 'STOP_DEPLOYMENT' : 'CONTINUE_DEPLOYMENT',
                waitTimeInMinutes: options.deploymentApprovalWaitTime?.toMinutes() ?? 0,
            },
            terminateBlueInstancesOnDeploymentSuccess: {
                action: 'TERMINATE',
                terminationWaitTimeInMinutes: options.terminationWaitTime?.toMinutes() ?? 0,
            },
        };
    }
    renderLoadBalancerInfo(options) {
        return {
            targetGroupPairInfoList: [
                {
                    targetGroups: [
                        {
                            name: options.blueTargetGroup.targetGroupName,
                        },
                        {
                            name: options.greenTargetGroup.targetGroupName,
                        },
                    ],
                    prodTrafficRoute: {
                        listenerArns: [
                            options.listener.listenerArn,
                        ],
                    },
                    testTrafficRoute: options.testListener ? {
                        listenerArns: [
                            options.testListener.listenerArn,
                        ],
                    } : undefined,
                },
            ],
        };
    }
}
exports.EcsDeploymentGroup = EcsDeploymentGroup;
_a = JSII_RTTI_SYMBOL_1;
EcsDeploymentGroup[_a] = { fqn: "@aws-cdk/aws-codedeploy.EcsDeploymentGroup", version: "0.0.0" };
class ImportedEcsDeploymentGroup extends base_deployment_group_1.ImportedDeploymentGroupBase {
    constructor(scope, id, props) {
        super(scope, id, {
            application: props.application,
            deploymentGroupName: props.deploymentGroupName,
        });
        this.application = props.application;
        this.deploymentConfig = this._bindDeploymentConfig(props.deploymentConfig || deployment_config_1.EcsDeploymentConfig.ALL_AT_ONCE);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwbG95bWVudC1ncm91cC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRlcGxveW1lbnQtZ3JvdXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0Esd0NBQXdDO0FBRXhDLHdDQUF3QztBQUN4QyxxQ0FBcUM7QUFDckMsNENBQWlGO0FBQ2pGLDJDQUF1QztBQUN2QywrQ0FBZ0U7QUFDaEUsMkRBQWdGO0FBQ2hGLGtFQUE2RDtBQUM3RCw0RUFBb0c7QUFDcEcsNENBQTZGO0FBMks3Rjs7O0dBR0c7QUFDSCxNQUFhLGtCQUFtQixTQUFRLDJDQUFtQjtJQTJCekQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUE4QjtRQUN0RSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRTtZQUNmLG1CQUFtQixFQUFFLEtBQUssQ0FBQyxtQkFBbUI7WUFDOUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJO1lBQ2hCLGVBQWUsRUFBRSxhQUFhO1NBQy9CLENBQUMsQ0FBQzs7Ozs7OytDQWhDTSxrQkFBa0I7Ozs7UUFpQzNCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUV2QixJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLElBQUksSUFBSSw0QkFBYyxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQztRQUNoRixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDO1FBRWpDLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDLENBQUM7UUFDbEcsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLElBQUksdUNBQW1CLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFOUcsSUFBSSxHQUFHLENBQUMsUUFBUSxD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TSwwQkFBMkIsU0FBUSxtREFBMkI7SUFJbEUsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFtQztRQUMzRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRTtZQUNmLFdBQVcsRUFBRSxLQUFLLENBQUMsV0FBVztZQUM5QixtQkFBbUIsRUFBRSxLQUFLLENBQUMsbUJBQW1CO1NBQy9DLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQztRQUNyQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsSUFBSSx1Q0FBbUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztLQUMvRztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2xvdWR3YXRjaCBmcm9tICdAYXdzLWNkay9hd3MtY2xvdWR3YXRjaCc7XG5pbXBvcnQgKiBhcyBlY3MgZnJvbSAnQGF3cy1jZGsvYXdzLWVjcyc7XG5pbXBvcnQgKiBhcyBlbGJ2MiBmcm9tICdAYXdzLWNkay9hd3MtZWxhc3RpY2xvYWRiYWxhbmNpbmd2Mic7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnQGF3cy1jZGsvYXdzLWlhbSc7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnQGF3cy1jZGsvY29yZSc7XG5pbXBvcnQgeyBDT0RFREVQTE9ZX1JFTU9WRV9BTEFSTVNfRlJPTV9ERVBMT1lNRU5UX0dST1VQIH0gZnJvbSAnQGF3cy1jZGsvY3gtYXBpJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgSUVjc0FwcGxpY2F0aW9uLCBFY3NBcHBsaWNhdGlvbiB9IGZyb20gJy4vYXBwbGljYXRpb24nO1xuaW1wb3J0IHsgRWNzRGVwbG95bWVudENvbmZpZywgSUVjc0RlcGxveW1lbnRDb25maWcgfSBmcm9tICcuL2RlcGxveW1lbnQtY29uZmlnJztcbmltcG9ydCB7IENmbkRlcGxveW1lbnRHcm91cCB9IGZyb20gJy4uL2NvZGVkZXBsb3kuZ2VuZXJhdGVkJztcbmltcG9ydCB7IEltcG9ydGVkRGVwbG95bWVudEdyb3VwQmFzZSwgRGVwbG95bWVudEdyb3VwQmFzZSB9IGZyb20gJy4uL3ByaXZhdGUvYmFzZS1kZXBsb3ltZW50LWdyb3VwJztcbmltcG9ydCB7IHJlbmRlckFsYXJtQ29uZmlndXJhdGlvbiwgcmVuZGVyQXV0b1JvbGxiYWNrQ29uZmlndXJhdGlvbiB9IGZyb20gJy4uL3ByaXZhdGUvdXRpbHMnO1xuaW1wb3J0IHsgQXV0b1JvbGxiYWNrQ29uZmlnIH0gZnJvbSAnLi4vcm9sbGJhY2stY29uZmlnJztcblxuLyoqXG4gKiBJbnRlcmZhY2UgZm9yIGFuIEVDUyBkZXBsb3ltZW50IGdyb3VwLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIElFY3NEZXBsb3ltZW50R3JvdXAgZXh0ZW5kcyBjZGsuSVJlc291cmNlIHtcbiAgLyoqXG4gICAqIFRoZSByZWZlcmVuY2UgdG8gdGhlIENvZGVEZXBsb3kgRUNTIEFwcGxpY2F0aW9uIHRoYXQgdGhpcyBEZXBsb3ltZW50IEdyb3VwIGJlbG9uZ3MgdG8uXG4gICAqL1xuICByZWFkb25seSBhcHBsaWNhdGlvbjogSUVjc0FwcGxpY2F0aW9uO1xuXG4gIC8qKlxuICAgKiBUaGUgcGh5c2ljYWwgbmFtZSBvZiB0aGUgQ29kZURlcGxveSBEZXBsb3ltZW50IEdyb3VwLlxuICAgKiBAYXR0cmlidXRlXG4gICAqL1xuICByZWFkb25seSBkZXBsb3ltZW50R3JvdXBOYW1lOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBBUk4gb2YgdGhpcyBEZXBsb3ltZW50IEdyb3VwLlxuICAgKiBAYXR0cmlidXRlXG4gICAqL1xuICByZWFkb25seSBkZXBsb3ltZW50R3JvdXBBcm46IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIERlcGxveW1lbnQgQ29uZmlndXJhdGlvbiB0aGlzIEdyb3VwIHVzZXMuXG4gICAqL1xuICByZWFkb25seSBkZXBsb3ltZW50Q29uZmlnOiBJRWNzRGVwbG95bWVudENvbmZpZztcbn1cblxuLyoqXG4gKiBTcGVjaWZ5IGhvdyB0aGUgZGVwbG95bWVudCBiZWhhdmVzIGFuZCBob3cgdHJhZmZpYyBpcyByb3V0ZWQgdG8gdGhlIEVDUyBzZXJ2aWNlIGR1cmluZyBhIGJsdWUtZ3JlZW4gRUNTIGRlcGxveW1lbnQuXG4gKlxuICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY29kZWRlcGxveS9sYXRlc3QvdXNlcmd1aWRlL2RlcGxveW1lbnQtc3RlcHMtZWNzLmh0bWwjZGVwbG95bWVudC1zdGVwcy13aGF0LWhhcHBlbnNcbiAqIEBzZWUgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2NvZGVkZXBsb3kvbGF0ZXN0L3VzZXJndWlkZS9yZWZlcmVuY2UtYXBwc3BlYy1maWxlLXN0cnVjdHVyZS1ob29rcy5odG1sI2FwcHNwZWMtaG9va3MtZWNzXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRWNzQmx1ZUdyZWVuRGVwbG95bWVudENvbmZpZyB7XG4gIC8qKlxuICAgKiBUaGUgdGFyZ2V0IGdyb3VwIHRoYXQgd2lsbCBiZSBhc3NvY2lhdGVkIHdpdGggdGhlICdibHVlJyBFQ1MgdGFzayBzZXQgZHVyaW5nIGEgYmx1ZS1ncmVlbiBkZXBsb3ltZW50LlxuICAgKi9cbiAgcmVhZG9ubHkgYmx1ZVRhcmdldEdyb3VwOiBlbGJ2Mi5JVGFyZ2V0R3JvdXA7XG5cbiAgLyoqXG4gICAqIFRoZSB0YXJnZXQgZ3JvdXAgdGhhdCB3aWxsIGJlIGFzc29jaWF0ZWQgd2l0aCB0aGUgJ2dyZWVuJyBFQ1MgdGFzayBzZXQgZHVyaW5nIGEgYmx1ZS1ncmVlbiBkZXBsb3ltZW50LlxuICAgKi9cbiAgcmVhZG9ubHkgZ3JlZW5UYXJnZXRHcm91cDogZWxidjIuSVRhcmdldEdyb3VwO1xuXG4gIC8qKlxuICAgKiBUaGUgbG9hZCBiYWxhbmNlciBsaXN0ZW5lciB1c2VkIHRvIHNlcnZlIHByb2R1Y3Rpb24gdHJhZmZpYyBhbmQgdG8gc2hpZnQgcHJvZHVjdGlvbiB0cmFmZmljIGZyb20gdGhlXG4gICAqICdibHVlJyBFQ1MgdGFzayBzZXQgdG8gdGhlICdncmVlbicgRUNTIHRhc2sgc2V0IGR1cmluZyBhIGJsdWUtZ3JlZW4gZGVwbG95bWVudC5cbiAgICovXG4gIHJlYWRvbmx5IGxpc3RlbmVyOiBlbGJ2Mi5JTGlzdGVuZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBsb2FkIGJhbGFuY2VyIGxpc3RlbmVyIHVzZWQgdG8gcm91dGUgdGVzdCB0cmFmZmljIHRvIHRoZSAnZ3JlZW4nIEVDUyB0YXNrIHNldCBkdXJpbmcgYSBibHVlLWdyZWVuIGRlcGxveW1lbnQuXG4gICAqXG4gICAqIER1cmluZyBhIGJsdWUtZ3JlZW4gZGVwbG95bWVudCwgdmFsaWRhdGlvbiBjYW4gb2NjdXIgYWZ0ZXIgdGVzdCB0cmFmZmljIGhhcyBiZWVuIHJlLXJvdXRlZCBhbmQgYmVmb3JlIHByb2R1Y3Rpb25cbiAgICogdHJhZmZpYyBoYXMgYmVlbiByZS1yb3V0ZWQgdG8gdGhlICdncmVlbicgRUNTIHRhc2sgc2V0LiAgWW91IGNhbiBzcGVjaWZ5IG9uZSBvciBtb3JlIExhbWJkYSBmdW50aW9ucyBpbiB0aGVcbiAgICogZGVwbG95bWVudCdzIEFwcFNwZWMgZmlsZSB0aGF0IHJ1biBkdXJpbmcgdGhlIEFmdGVyQWxsb3dUZXN0VHJhZmZpYyBob29rLiBUaGUgZnVuY3Rpb25zIGNhbiBydW4gdmFsaWRhdGlvbiB0ZXN0cy5cbiAgICogSWYgYSB2YWxpZGF0aW9uIHRlc3QgZmFpbHMsIGEgZGVwbG95bWVudCByb2xsYmFjayBpcyB0cmlnZ2VyZWQuIElmIHRoZSB2YWxpZGF0aW9uIHRlc3RzIHN1Y2NlZWQsIHRoZSBuZXh0IGhvb2sgaW5cbiAgICogdGhlIGRlcGxveW1lbnQgbGlmZWN5Y2xlLCBCZWZvcmVBbGxvd1RyYWZmaWMsIGlzIHRyaWdnZXJlZC5cbiAgICpcbiAgICogSWYgYSB0ZXN0IGxpc3RlbmVyIGlzIG5vdCBzcGVjaWZpZWQsIHRoZSBkZXBsb3ltZW50IHdpbGwgcHJvY2VlZCB0byByb3V0aW5nIHRoZSBwcm9kdWN0aW9uIGxpc3RlbmVyIHRvIHRoZSAnZ3JlZW4nIEVDUyB0YXNrIHNldFxuICAgKiBhbmQgd2lsbCBza2lwIHRoZSBBZnRlckFsbG93VGVzdFRyYWZmaWMgaG9vay5cbiAgICpcbiAgICogQGRlZmF1bHQgTm8gdGVzdCBsaXN0ZW5lciB3aWxsIGJlIGFkZGVkXG4gICAqL1xuICByZWFkb25seSB0ZXN0TGlzdGVuZXI/OiBlbGJ2Mi5JTGlzdGVuZXI7XG5cbiAgLyoqXG4gICAqIFNwZWNpZnkgaG93IGxvbmcgQ29kZURlcGxveSB3YWl0cyBmb3IgYXBwcm92YWwgdG8gY29udGludWUgYSBibHVlLWdyZWVuIGRlcGxveW1lbnQgYmVmb3JlIGl0IHN0b3BzIHRoZSBkZXBsb3ltZW50LlxuICAgKlxuICAgKiBBZnRlciBwcm92aXNpb25pbmcgdGhlICdncmVlbicgRUNTIHRhc2sgc2V0IGFuZCByZS1yb3V0aW5nIHRlc3QgdHJhZmZpYywgQ29kZURlcGxveSBjYW4gd2FpdCBmb3IgYXBwcm92YWwgYmVmb3JlXG4gICAqIGNvbnRpbnVpbmcgdGhlIGRlcGxveW1lbnQgYW5kIHJlLXJvdXRpbmcgcHJvZHVjdGlvbiB0cmFmZmljLiAgRHVyaW5nIHRoaXMgd2FpdCB0aW1lLCB2YWxpZGF0aW9uIHN1Y2ggYXMgbWFudWFsXG4gICAqIHRlc3Rpbmcgb3IgcnVubmluZyBpbnRlZ3JhdGlvbiB0ZXN0cyBjYW4gb2NjdXIgdXNpbmcgdGhlIHRlc3QgdHJhZmZpYyBwb3J0LCBwcmlvciB0byBleHBvc2luZyB0aGUgbmV3ICdncmVlbicgdGFza1xuICAgKiBzZXQgdG8gcHJvZHVjdGlvbiB0cmFmZmljLiAgVG8gYXBwcm92ZSB0aGUgZGVwbG95bWVudCwgdmFsaWRhdGlvbiBzdGVwcyB1c2UgdGhlIENvZGVEZXBsb3lcbiAgICogW0NvbnRpbnVlRGVwbG95bWVudCBBUEkoaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2NvZGVkZXBsb3kvbGF0ZXN0L0FQSVJlZmVyZW5jZS9BUElfQ29udGludWVEZXBsb3ltZW50Lmh0bWwpLlxuICAgKiBJZiB0aGUgQ29udGludWVEZXBsb3ltZW50IEFQSSBpcyBub3QgY2FsbGVkIHdpdGhpbiB0aGUgd2FpdCB0aW1lIHBlcmlvZCwgQ29kZURlcGxveSB3aWxsIHN0b3AgdGhlIGRlcGxveW1lbnQuXG4gICAqXG4gICAqIEJ5IGRlZmF1bHQsIENvZGVEZXBsb3kgd2lsbCBub3Qgd2FpdCBmb3IgZGVwbG95bWVudCBhcHByb3ZhbC4gIEFmdGVyIHJlLXJvdXRpbmcgdGVzdCB0cmFmZmljIHRvIHRoZSAnZ3JlZW4nIEVDUyB0YXNrIHNldFxuICAgKiBhbmQgcnVubmluZyBhbnkgJ0FmdGVyQWxsb3dUZXN0VHJhZmZpYycgYW5kICdCZWZvcmVBbGxvd1RyYWZmaWMnIGxpZmVjeWNsZSBob29rcywgdGhlIGRlcGxveW1lbnQgd2lsbCBpbW1lZGlhdGVseVxuICAgKiByZS1yb3V0ZSBwcm9kdWN0aW9uIHRyYWZmaWMgdG8gdGhlICdncmVlbicgRUNTIHRhc2sgc2V0LlxuICAgKlxuICAgKiBAZGVmYXVsdCAwXG4gICAqL1xuICByZWFkb25seSBkZXBsb3ltZW50QXBwcm92YWxXYWl0VGltZT86IGNkay5EdXJhdGlvbjtcblxuICAvKipcbiAgICAqIFNwZWNpZnkgaG93IGxvbmcgQ29kZURlcGxveSB3YWl0cyBiZWZvcmUgaXQgdGVybWluYXRlcyB0aGUgb3JpZ2luYWwgJ2JsdWUnIEVDUyB0YXNrIHNldCB3aGVuIGEgYmx1ZS1ncmVlbiBkZXBsb3ltZW50IGlzIGNvbXBsZXRlLlxuICAgICpcbiAgICAqIER1cmluZyB0aGlzIHdhaXQgdGltZSwgQ29kZURlcGxveSB3aWxsIGNvbnRpbnVlIHRvIG1vbml0b3IgYW55IENsb3VkV2F0Y2ggYWxhcm1zIHNwZWNpZmllZCBmb3IgdGhlIGRlcGxveW1lbnQgZ3JvdXAsXG4gICAgKiBhbmQgdGhlIGRlcGxveW1lbnQgZ3JvdXAgY2FuIGJlIGNvbmZpZ3VyZWQgdG8gYXV0b21hdGljYWxseSByb2xsIGJhY2sgaWYgdGhvc2UgYWxhcm1zIGZpcmUuICBPbmNlIENvZGVEZXBsb3kgYmVnaW5zIHRvXG4gICAgKiB0ZXJtaW5hdGUgdGhlICdibHVlJyBFQ1MgdGFzayBzZXQsIHRoZSBkZXBsb3ltZW50IGNhbiBubyBsb25nZXIgYmUgcm9sbGVkIGJhY2ssIG1hbnVhbGx5IG9yIGF1dG9tYXRpY2FsbHkuXG4gICAgKlxuICAgICogQnkgZGVmYXVsdCwgdGhlIGRlcGxveW1lbnQgd2lsbCBpbW1lZGlhdGVseSB0ZXJtaW5hdGUgdGhlICdibHVlJyBFQ1MgdGFzayBzZXQgYWZ0ZXIgcHJvZHVjdGlvbiB0cmFmZmljIGlzIHN1Y2Nlc3NmdWxseVxuICAgICogcm91dGVkIHRvIHRoZSAnZ3JlZW4nIEVDUyB0YXNrIHNldC5cbiAgICAqXG4gICAgKiBAZGVmYXVsdCAwXG4gICAgKi9cbiAgcmVhZG9ubHkgdGVybWluYXRpb25XYWl0VGltZT86IGNkay5EdXJhdGlvbjtcbn1cblxuLyoqXG4gKiBDb25zdHJ1Y3Rpb24gcHJvcGVydGllcyBmb3IgYEVjc0RlcGxveW1lbnRHcm91cGAuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRWNzRGVwbG95bWVudEdyb3VwUHJvcHMge1xuICAvKipcbiAgICogVGhlIHJlZmVyZW5jZSB0byB0aGUgQ29kZURlcGxveSBFQ1MgQXBwbGljYXRpb24gdGhhdCB0aGlzIERlcGxveW1lbnQgR3JvdXAgYmVsb25ncyB0by5cbiAgICpcbiAgICogQGRlZmF1bHQgT25lIHdpbGwgYmUgY3JlYXRlZCBmb3IgeW91LlxuICAgKi9cbiAgcmVhZG9ubHkgYXBwbGljYXRpb24/OiBJRWNzQXBwbGljYXRpb247XG5cbiAgLyoqXG4gICAqIFRoZSBwaHlzaWNhbCwgaHVtYW4tcmVhZGFibGUgbmFtZSBvZiB0aGUgQ29kZURlcGxveSBEZXBsb3ltZW50IEdyb3VwLlxuICAgKlxuICAgKiBAZGVmYXVsdCBBbiBhdXRvLWdlbmVyYXRlZCBuYW1lIHdpbGwgYmUgdXNlZC5cbiAgICovXG4gIHJlYWRvbmx5IGRlcGxveW1lbnRHcm91cE5hbWU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBEZXBsb3ltZW50IENvbmZpZ3VyYXRpb24gdGhpcyBEZXBsb3ltZW50IEdyb3VwIHVzZXMuXG4gICAqXG4gICAqIEBkZWZhdWx0IEVjc0RlcGxveW1lbnRDb25maWcuQUxMX0FUX09OQ0VcbiAgICovXG4gIHJlYWRvbmx5IGRlcGxveW1lbnRDb25maWc/OiBJRWNzRGVwbG95bWVudENvbmZpZztcblxuICAvKipcbiAgICogVGhlIENsb3VkV2F0Y2ggYWxhcm1zIGFzc29jaWF0ZWQgd2l0aCB0aGlzIERlcGxveW1lbnQgR3JvdXAuXG4gICAqIENvZGVEZXBsb3kgd2lsbCBzdG9wIChhbmQgb3B0aW9uYWxseSByb2xsIGJhY2spXG4gICAqIGEgZGVwbG95bWVudCBpZiBkdXJpbmcgaXQgYW55IG9mIHRoZSBhbGFybXMgdHJpZ2dlci5cbiAgICpcbiAgICogQWxhcm1zIGNhbiBhbHNvIGJlIGFkZGVkIGFmdGVyIHRoZSBEZXBsb3ltZW50IEdyb3VwIGlzIGNyZWF0ZWQgdXNpbmcgdGhlIGAjYWRkQWxhcm1gIG1ldGhvZC5cbiAgICpcbiAgICogQGRlZmF1bHQgW11cbiAgICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY29kZWRlcGxveS9sYXRlc3QvdXNlcmd1aWRlL21vbml0b3JpbmctY3JlYXRlLWFsYXJtcy5odG1sXG4gICAqL1xuICByZWFkb25seSBhbGFybXM/OiBjbG91ZHdhdGNoLklBbGFybVtdO1xuXG4gIC8qKlxuICAgKiBUaGUgc2VydmljZSBSb2xlIG9mIHRoaXMgRGVwbG95bWVudCBHcm91cC5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBBIG5ldyBSb2xlIHdpbGwgYmUgY3JlYXRlZC5cbiAgICovXG4gIHJlYWRvbmx5IHJvbGU/OiBpYW0uSVJvbGU7XG5cbiAgLyoqXG4gICAqIFRoZSBFQ1Mgc2VydmljZSB0byBkZXBsb3kgd2l0aCB0aGlzIERlcGxveW1lbnQgR3JvdXAuXG4gICAqL1xuICByZWFkb25seSBzZXJ2aWNlOiBlY3MuSUJhc2VTZXJ2aWNlO1xuXG4gIC8qKlxuICAgKiBUaGUgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciBibHVlLWdyZWVuIEVDUyBkZXBsb3ltZW50c1xuICAgKi9cbiAgcmVhZG9ubHkgYmx1ZUdyZWVuRGVwbG95bWVudENvbmZpZzogRWNzQmx1ZUdyZWVuRGVwbG95bWVudENvbmZpZztcblxuICAvKipcbiAgICogV2hldGhlciB0byBjb250aW51ZSBhIGRlcGxveW1lbnQgZXZlbiBpZiBmZXRjaGluZyB0aGUgYWxhcm0gc3RhdHVzIGZyb20gQ2xvdWRXYXRjaCBmYWlsZWQuXG4gICAqXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICByZWFkb25seSBpZ25vcmVQb2xsQWxhcm1zRmFpbHVyZT86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIFRoZSBhdXRvLXJvbGxiYWNrIGNvbmZpZ3VyYXRpb24gZm9yIHRoaXMgRGVwbG95bWVudCBHcm91cC5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBkZWZhdWx0IEF1dG9Sb2xsYmFja0NvbmZpZy5cbiAgICovXG4gIHJlYWRvbmx5IGF1dG9Sb2xsYmFjaz86IEF1dG9Sb2xsYmFja0NvbmZpZztcbn1cblxuLyoqXG4gKiBBIENvZGVEZXBsb3kgZGVwbG95bWVudCBncm91cCB0aGF0IG9yY2hlc3RyYXRlcyBFQ1MgYmx1ZS1ncmVlbiBkZXBsb3ltZW50cy5cbiAqIEByZXNvdXJjZSBBV1M6OkNvZGVEZXBsb3k6OkRlcGxveW1lbnRHcm91cFxuICovXG5leHBvcnQgY2xhc3MgRWNzRGVwbG95bWVudEdyb3VwIGV4dGVuZHMgRGVwbG95bWVudEdyb3VwQmFzZSBpbXBsZW1lbnRzIElFY3NEZXBsb3ltZW50R3JvdXAge1xuICAvKipcbiAgICogUmVmZXJlbmNlIGFuIEVDUyBEZXBsb3ltZW50IEdyb3VwIGRlZmluZWQgb3V0c2lkZSB0aGUgQ0RLIGFwcC5cbiAgICpcbiAgICogQWNjb3VudCBhbmQgcmVnaW9uIGZvciB0aGUgRGVwbG95bWVudEdyb3VwIGFyZSB0YWtlbiBmcm9tIHRoZSBhcHBsaWNhdGlvbi5cbiAgICpcbiAgICogQHBhcmFtIHNjb3BlIHRoZSBwYXJlbnQgQ29uc3RydWN0IGZvciB0aGlzIG5ldyBDb25zdHJ1Y3RcbiAgICogQHBhcmFtIGlkIHRoZSBsb2dpY2FsIElEIG9mIHRoaXMgbmV3IENvbnN0cnVjdFxuICAgKiBAcGFyYW0gYXR0cnMgdGhlIHByb3BlcnRpZXMgb2YgdGhlIHJlZmVyZW5jZWQgRGVwbG95bWVudCBHcm91cFxuICAgKiBAcmV0dXJucyBhIENvbnN0cnVjdCByZXByZXNlbnRpbmcgYSByZWZlcmVuY2UgdG8gYW4gZXhpc3RpbmcgRGVwbG95bWVudCBHcm91cFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBmcm9tRWNzRGVwbG95bWVudEdyb3VwQXR0cmlidXRlcyhcbiAgICBzY29wZTpDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICBhdHRyczogRWNzRGVwbG95bWVudEdyb3VwQXR0cmlidXRlcyk6IElFY3NEZXBsb3ltZW50R3JvdXAge1xuICAgIHJldHVybiBuZXcgSW1wb3J0ZWRFY3NEZXBsb3ltZW50R3JvdXAoc2NvcGUsIGlkLCBhdHRycyk7XG4gIH1cblxuICBwdWJsaWMgcmVhZG9ubHkgYXBwbGljYXRpb246IElFY3NBcHBsaWNhdGlvbjtcbiAgcHVibGljIHJlYWRvbmx5IGRlcGxveW1lbnRDb25maWc6IElFY3NEZXBsb3ltZW50Q29uZmlnO1xuICAvKipcbiAgICogVGhlIHNlcnZpY2UgUm9sZSBvZiB0aGlzIERlcGxveW1lbnQgR3JvdXAuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgcm9sZTogaWFtLklSb2xlO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgYWxhcm1zOiBjbG91ZHdhdGNoLklBbGFybVtdO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBFY3NEZXBsb3ltZW50R3JvdXBQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwge1xuICAgICAgZGVwbG95bWVudEdyb3VwTmFtZTogcHJvcHMuZGVwbG95bWVudEdyb3VwTmFtZSxcbiAgICAgIHJvbGU6IHByb3BzLnJvbGUsXG4gICAgICByb2xlQ29uc3RydWN0SWQ6ICdTZXJ2aWNlUm9sZScsXG4gICAgfSk7XG4gICAgdGhpcy5yb2xlID0gdGhpcy5fcm9sZTtcblxuICAgIHRoaXMuYXBwbGljYXRpb24gPSBwcm9wcy5hcHBsaWNhdGlvbiB8fCBuZXcgRWNzQXBwbGljYXRpb24odGhpcywgJ0FwcGxpY2F0aW9uJyk7XG4gICAgdGhpcy5hbGFybXMgPSBwcm9wcy5hbGFybXMgfHwgW107XG5cbiAgICB0aGlzLnJvbGUuYWRkTWFuYWdlZFBvbGljeShpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoJ0FXU0NvZGVEZXBsb3lSb2xlRm9yRUNTJykpO1xuICAgIHRoaXMuZGVwbG95bWVudENvbmZpZyA9IHRoaXMuX2JpbmREZXBsb3ltZW50Q29uZmlnKHByb3BzLmRlcGxveW1lbnRDb25maWcgfHwgRWNzRGVwbG95bWVudENvbmZpZy5BTExfQVRfT05DRSk7XG5cbiAgICBpZiAoY2RrLlJlc291cmNlLmlzT3duZWRSZXNvdXJjZShwcm9wcy5zZXJ2aWNlKSkge1xuICAgICAgY29uc3QgY2ZuU3ZjID0gKHByb3BzLnNlcnZpY2UgYXMgZWNzLkJhc2VTZXJ2aWNlKS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBlY3MuQ2ZuU2VydmljZTtcbiAgICAgIGlmIChjZm5TdmMuZGVwbG95bWVudENvbnRyb2xsZXIgPT09IHVuZGVmaW5lZCB8fFxuICAgICAgICAoY2ZuU3ZjLmRlcGxveW1lbnRDb250cm9sbGVyISBhcyBlY3MuQ2ZuU2VydmljZS5EZXBsb3ltZW50Q29udHJvbGxlclByb3BlcnR5KS50eXBlICE9PSBlY3MuRGVwbG95bWVudENvbnRyb2xsZXJUeXBlLkNPREVfREVQTE9ZKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnVGhlIEVDUyBzZXJ2aWNlIGFzc29jaWF0ZWQgd2l0aCB0aGUgZGVwbG95bWVudCBncm91cCBtdXN0IHVzZSB0aGUgQ09ERV9ERVBMT1kgZGVwbG95bWVudCBjb250cm9sbGVyIHR5cGUnLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2ZuU3ZjLnRhc2tEZWZpbml0aW9uICE9PSAocHJvcHMuc2VydmljZSBhcyBlY3MuQmFzZVNlcnZpY2UpLnRhc2tEZWZpbml0aW9uLmZhbWlseSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ1RoZSBFQ1Mgc2VydmljZSBhc3NvY2lhdGVkIHdpdGggdGhlIGRlcGxveW1lbnQgZ3JvdXAgbXVzdCBzcGVjaWZ5IHRoZSB0YXNrIGRlZmluaXRpb24gdXNpbmcgdGhlIHRhc2sgZGVmaW5pdGlvbiBmYW1pbHkgbmFtZSBvbmx5LiBPdGhlcndpc2UsIHRoZSB0YXNrIGRlZmluaXRpb24gY2Fubm90IGJlIHVwZGF0ZWQgaW4gdGhlIHN0YWNrJyxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCByZW1vdmVBbGFybXNGcm9tRGVwbG95bWVudEdyb3VwID0gY2RrLkZlYXR1cmVGbGFncy5vZih0aGlzKS5pc0VuYWJsZWQoQ09ERURFUExPWV9SRU1PVkVfQUxBUk1TX0ZST01fREVQTE9ZTUVOVF9HUk9VUCk7XG5cbiAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBDZm5EZXBsb3ltZW50R3JvdXAodGhpcywgJ1Jlc291cmNlJywge1xuICAgICAgYXBwbGljYXRpb25OYW1lOiB0aGlzLmFwcGxpY2F0aW9uLmFwcGxpY2F0aW9uTmFtZSxcbiAgICAgIHNlcnZpY2VSb2xlQXJuOiB0aGlzLnJvbGUucm9sZUFybixcbiAgICAgIGRlcGxveW1lbnRHcm91cE5hbWU6IHRoaXMucGh5c2ljYWxOYW1lLFxuICAgICAgZGVwbG95bWVudENvbmZpZ05hbWU6IHRoaXMuZGVwbG95bWVudENvbmZpZy5kZXBsb3ltZW50Q29uZmlnTmFtZSxcbiAgICAgIGRlcGxveW1lbnRTdHlsZToge1xuICAgICAgICBkZXBsb3ltZW50VHlwZTogJ0JMVUVfR1JFRU4nLFxuICAgICAgICBkZXBsb3ltZW50T3B0aW9uOiAnV0lUSF9UUkFGRklDX0NPTlRST0wnLFxuICAgICAgfSxcbiAgICAgIGVjc1NlcnZpY2VzOiBbe1xuICAgICAgICBjbHVzdGVyTmFtZTogcHJvcHMuc2VydmljZS5jbHVzdGVyLmNsdXN0ZXJOYW1lLFxuICAgICAgICBzZXJ2aWNlTmFtZTogcHJvcHMuc2VydmljZS5zZXJ2aWNlTmFtZSxcbiAgICAgIH1dLFxuICAgICAgYmx1ZUdyZWVuRGVwbG95bWVudENvbmZpZ3VyYXRpb246IGNkay5MYXp5LmFueSh7XG4gICAgICAgIHByb2R1Y2U6ICgpID0+IHRoaXMucmVuZGVyQmx1ZUdyZWVuRGVwbG95bWVudENvbmZpZ3VyYXRpb24ocHJvcHMuYmx1ZUdyZWVuRGVwbG95bWVudENvbmZpZyksXG4gICAgICB9KSxcbiAgICAgIGxvYWRCYWxhbmNlckluZm86IGNkay5MYXp5LmFueSh7IHByb2R1Y2U6ICgpID0+IHRoaXMucmVuZGVyTG9hZEJhbGFuY2VySW5mbyhwcm9wcy5ibHVlR3JlZW5EZXBsb3ltZW50Q29uZmlnKSB9KSxcbiAgICAgIGFsYXJtQ29uZmlndXJhdGlvbjogY2RrLkxhenkuYW55KHtcbiAgICAgICAgcHJvZHVjZTogKCkgPT4gcmVuZGVyQWxhcm1Db25maWd1cmF0aW9uKHRoaXMuYWxhcm1zLCBwcm9wcy5pZ25vcmVQb2xsQWxhcm1zRmFpbHVyZSwgcmVtb3ZlQWxhcm1zRnJvbURlcGxveW1lbnRHcm91cCksXG4gICAgICB9KSxcbiAgICAgIGF1dG9Sb2xsYmFja0NvbmZpZ3VyYXRpb246IGNkay5MYXp5LmFueSh7IHByb2R1Y2U6ICgpID0+IHJlbmRlckF1dG9Sb2xsYmFja0NvbmZpZ3VyYXRpb24odGhpcy5hbGFybXMsIHByb3BzLmF1dG9Sb2xsYmFjaykgfSksXG4gICAgfSk7XG5cbiAgICB0aGlzLl9zZXROYW1lQW5kQXJuKHJlc291cmNlLCB0aGlzLmFwcGxpY2F0aW9uKTtcblxuICAgIC8vIElmIHRoZSBkZXBsb3ltZW50IGNvbmZpZyBpcyBhIGNvbnN0cnVjdCwgYWRkIGEgZGVwZW5kZW5jeSB0byBlbnN1cmUgdGhlIGRlcGxveW1lbnQgY29uZmlnXG4gICAgLy8gaXMgY3JlYXRlZCBiZWZvcmUgdGhlIGRlcGxveW1lbnQgZ3JvdXAgaXMuXG4gICAgaWYgKENvbnN0cnVjdC5pc0NvbnN0cnVjdCh0aGlzLmRlcGxveW1lbnRDb25maWcpKSB7XG4gICAgICB0aGlzLm5vZGUuYWRkRGVwZW5kZW5jeSh0aGlzLmRlcGxveW1lbnRDb25maWcpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBc3NvY2lhdGVzIGFuIGFkZGl0aW9uYWwgYWxhcm0gd2l0aCB0aGlzIERlcGxveW1lbnQgR3JvdXAuXG4gICAqXG4gICAqIEBwYXJhbSBhbGFybSB0aGUgYWxhcm0gdG8gYXNzb2NpYXRlIHdpdGggdGhpcyBEZXBsb3ltZW50IEdyb3VwXG4gICAqL1xuICBwdWJsaWMgYWRkQWxhcm0oYWxhcm06IGNsb3Vkd2F0Y2guSUFsYXJtKTogdm9pZCB7XG4gICAgdGhpcy5hbGFybXMucHVzaChhbGFybSk7XG4gIH1cblxuICBwcml2YXRlIHJlbmRlckJsdWVHcmVlbkRlcGxveW1lbnRDb25maWd1cmF0aW9uKG9wdGlvbnM6IEVjc0JsdWVHcmVlbkRlcGxveW1lbnRDb25maWcpOlxuICBDZm5EZXBsb3ltZW50R3JvdXAuQmx1ZUdyZWVuRGVwbG95bWVudENvbmZpZ3VyYXRpb25Qcm9wZXJ0eSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGRlcGxveW1lbnRSZWFkeU9wdGlvbjoge1xuICAgICAgICBhY3Rpb25PblRpbWVvdXQ6IG9wdGlvbnMuZGVwbG95bWVudEFwcHJvdmFsV2FpdFRpbWUgPyAnU1RPUF9ERVBMT1lNRU5UJyA6ICdDT05USU5VRV9ERVBMT1lNRU5UJyxcbiAgICAgICAgd2FpdFRpbWVJbk1pbnV0ZXM6IG9wdGlvbnMuZGVwbG95bWVudEFwcHJvdmFsV2FpdFRpbWU/LnRvTWludXRlcygpID8/IDAsXG4gICAgICB9LFxuICAgICAgdGVybWluYXRlQmx1ZUluc3RhbmNlc09uRGVwbG95bWVudFN1Y2Nlc3M6IHtcbiAgICAgICAgYWN0aW9uOiAnVEVSTUlOQVRFJyxcbiAgICAgICAgdGVybWluYXRpb25XYWl0VGltZUluTWludXRlczogb3B0aW9ucy50ZXJtaW5hdGlvbldhaXRUaW1lPy50b01pbnV0ZXMoKSA/PyAwLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSByZW5kZXJMb2FkQmFsYW5jZXJJbmZvKG9wdGlvbnM6IEVjc0JsdWVHcmVlbkRlcGxveW1lbnRDb25maWcpOiBDZm5EZXBsb3ltZW50R3JvdXAuTG9hZEJhbGFuY2VySW5mb1Byb3BlcnR5IHtcbiAgICByZXR1cm4ge1xuICAgICAgdGFyZ2V0R3JvdXBQYWlySW5mb0xpc3Q6IFtcbiAgICAgICAge1xuICAgICAgICAgIHRhcmdldEdyb3VwczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBuYW1lOiBvcHRpb25zLmJsdWVUYXJnZXRHcm91cC50YXJnZXRHcm91cE5hbWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBuYW1lOiBvcHRpb25zLmdyZWVuVGFyZ2V0R3JvdXAudGFyZ2V0R3JvdXBOYW1lLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICBdLFxuICAgICAgICAgIHByb2RUcmFmZmljUm91dGU6IHtcbiAgICAgICAgICAgIGxpc3RlbmVyQXJuczogW1xuICAgICAgICAgICAgICBvcHRpb25zLmxpc3RlbmVyLmxpc3RlbmVyQXJuLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRlc3RUcmFmZmljUm91dGU6IG9wdGlvbnMudGVzdExpc3RlbmVyID8ge1xuICAgICAgICAgICAgbGlzdGVuZXJBcm5zOiBbXG4gICAgICAgICAgICAgIG9wdGlvbnMudGVzdExpc3RlbmVyLmxpc3RlbmVyQXJuLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICB9IDogdW5kZWZpbmVkLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9O1xuICB9XG59XG5cbi8qKlxuICogUHJvcGVydGllcyBvZiBhIHJlZmVyZW5jZSB0byBhIENvZGVEZXBsb3kgRUNTIERlcGxveW1lbnQgR3JvdXAuXG4gKlxuICogQHNlZSBFY3NEZXBsb3ltZW50R3JvdXAjZnJvbUVjc0RlcGxveW1lbnRHcm91cEF0dHJpYnV0ZXNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFY3NEZXBsb3ltZW50R3JvdXBBdHRyaWJ1dGVzIHtcbiAgLyoqXG4gICAqIFRoZSByZWZlcmVuY2UgdG8gdGhlIENvZGVEZXBsb3kgRUNTIEFwcGxpY2F0aW9uXG4gICAqIHRoYXQgdGhpcyBEZXBsb3ltZW50IEdyb3VwIGJlbG9uZ3MgdG8uXG4gICAqL1xuICByZWFkb25seSBhcHBsaWNhdGlvbjogSUVjc0FwcGxpY2F0aW9uO1xuXG4gIC8qKlxuICAgKiBUaGUgcGh5c2ljYWwsIGh1bWFuLXJlYWRhYmxlIG5hbWUgb2YgdGhlIENvZGVEZXBsb3kgRUNTIERlcGxveW1lbnQgR3JvdXBcbiAgICogdGhhdCB3ZSBhcmUgcmVmZXJlbmNpbmcuXG4gICAqL1xuICByZWFkb25seSBkZXBsb3ltZW50R3JvdXBOYW1lOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBEZXBsb3ltZW50IENvbmZpZ3VyYXRpb24gdGhpcyBEZXBsb3ltZW50IEdyb3VwIHVzZXMuXG4gICAqXG4gICAqIEBkZWZhdWx0IEVjc0RlcGxveW1lbnRDb25maWcuQUxMX0FUX09OQ0VcbiAgICovXG4gIHJlYWRvbmx5IGRlcGxveW1lbnRDb25maWc/OiBJRWNzRGVwbG95bWVudENvbmZpZztcbn1cblxuY2xhc3MgSW1wb3J0ZWRFY3NEZXBsb3ltZW50R3JvdXAgZXh0ZW5kcyBJbXBvcnRlZERlcGxveW1lbnRHcm91cEJhc2UgaW1wbGVtZW50cyBJRWNzRGVwbG95bWVudEdyb3VwIHtcbiAgcHVibGljIHJlYWRvbmx5IGFwcGxpY2F0aW9uOiBJRWNzQXBwbGljYXRpb247XG4gIHB1YmxpYyByZWFkb25seSBkZXBsb3ltZW50Q29uZmlnOiBJRWNzRGVwbG95bWVudENvbmZpZztcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogRWNzRGVwbG95bWVudEdyb3VwQXR0cmlidXRlcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwge1xuICAgICAgYXBwbGljYXRpb246IHByb3BzLmFwcGxpY2F0aW9uLFxuICAgICAgZGVwbG95bWVudEdyb3VwTmFtZTogcHJvcHMuZGVwbG95bWVudEdyb3VwTmFtZSxcbiAgICB9KTtcblxuICAgIHRoaXMuYXBwbGljYXRpb24gPSBwcm9wcy5hcHBsaWNhdGlvbjtcbiAgICB0aGlzLmRlcGxveW1lbnRDb25maWcgPSB0aGlzLl9iaW5kRGVwbG95bWVudENvbmZpZyhwcm9wcy5kZXBsb3ltZW50Q29uZmlnIHx8IEVjc0RlcGxveW1lbnRDb25maWcuQUxMX0FUX09OQ0UpO1xuICB9XG59XG4iXX0=