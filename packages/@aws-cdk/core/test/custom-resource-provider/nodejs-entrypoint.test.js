"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assert = require("assert");
const fs = require("fs");
const os = require("os");
const path = require("path");
const url = require("url");
const entrypoint = require("../../lib/custom-resource-provider/nodejs-entrypoint");
describe('nodejs entrypoint', () => {
    describe('handler return value is sent back to cloudformation as a success response', () => {
        test('physical resource id (ref)', async () => {
            // GIVEN
            const createEvent = makeEvent({ RequestType: 'Create' });
            // WHEN
            const response = await invokeHandler(createEvent, async (_) => ({ PhysicalResourceId: 'returned-from-handler' }));
            // THEN
            expect(response.Status).toEqual('SUCCESS');
            expect(response.PhysicalResourceId).toEqual('returned-from-handler');
        });
        test('data (attributes)', async () => {
            // GIVEN
            const createEvent = makeEvent({ RequestType: 'Create' });
            // WHEN
            const response = await invokeHandler(createEvent, async (_) => {
                return {
                    Data: {
                        Attribute1: 'hello',
                        Attribute2: {
                            Foo: 1111,
                        },
                    },
                };
            });
            // THEN
            expect(response.Status).toEqual('SUCCESS');
            expect(response.PhysicalResourceId).toEqual('<RequestId>');
            expect(response.Data).toEqual({
                Attribute1: 'hello',
                Attribute2: {
                    Foo: 1111,
                },
            });
        });
        test('no echo', async () => {
            // GIVEN
            const createEvent = makeEvent({ RequestType: 'Create' });
            // WHEN
            const response = await invokeHandler(createEvent, async (_) => ({ NoEcho: true }));
            // THEN
            expect(response.Status).toEqual('SUCCESS');
            expect(response.NoEcho).toEqual(true);
        });
        test('reason', async () => {
            // GIVEN
            const createEvent = makeEvent({ RequestType: 'Create' });
            // WHEN
            const response = await invokeHandler(createEvent, async (_) => ({ Reason: 'hello, reason' }));
            // THEN
            expect(response.Status).toEqual('SUCCESS');
            expect(response.Reason).toEqual('hello, reason');
        });
    });
    test('an error thrown by the handler is sent as a failure response to cloudformation', async () => {
        // GIVEN
        const createEvent = makeEvent({ RequestType: 'Create' });
        // WHEN
        const response = await invokeHandler(createEvent, async (_) => {
            throw new Error('this is an error');
        });
        // THEN
        expect(response).toEqual({
            Status: 'FAILED',
            Reason: 'this is an error',
            StackId: '<StackId>',
            RequestId: '<RequestId>',
            PhysicalResourceId: 'AWSCDK::CustomResourceProviderFramework::CREATE_FAILED',
            LogicalResourceId: '<LogicalResourceId>',
        });
    });
    test('physical resource id cannot be changed in DELETE', async () => {
        // GIVEN
        const event = makeEvent({ RequestType: 'Delete' });
        // WHEN
        const response = await invokeHandler(event, async (_) => ({
            PhysicalResourceId: 'Changed',
        }));
        // THEN
        expect(response).toEqual({
            Status: 'FAILED',
            Reason: 'DELETE: cannot change the physical resource ID from "undefined" to "Changed" during deletion',
            StackId: '<StackId>',
            RequestId: '<RequestId>',
            PhysicalResourceId: 'AWSCDK::CustomResourceProviderFramework::MISSING_PHYSICAL_ID',
            LogicalResourceId: '<LogicalResourceId>',
        });
    });
    test('DELETE after CREATE is ignored with success', async () => {
        // GIVEN
        const event = makeEvent({
            RequestType: 'Delete',
            PhysicalResourceId: 'AWSCDK::CustomResourceProviderFramework::CREATE_FAILED',
        });
        // WHEN
        const response = await invokeHandler(event, async (_) => {
            throw new Error('handler should not be called');
        });
        // THEN
        expect(response).toEqual({
            Status: 'SUCCESS',
            Reason: 'SUCCESS',
            StackId: '<StackId>',
            RequestId: '<RequestId>',
            PhysicalResourceId: 'AWSCDK::CustomResourceProviderFramework::CREATE_FAILED',
            LogicalResourceId: '<LogicalResourceId>',
        });
    });
});
function makeEvent(req) {
    return {
        LogicalResourceId: '<LogicalResourceId>',
        RequestId: '<RequestId>',
        ResourceType: '<ResourceType>',
        ResponseURL: '<ResponseURL>',
        ServiceToken: '<ServiceToken>',
        StackId: '<StackId>',
        ResourceProperties: {
            ServiceToken: '<ServiceToken>',
            ...req.ResourceProperties,
        },
        ...req,
    };
}
async function invokeHandler(req, userHandler) {
    const parsedResponseUrl = url.parse(req.ResponseURL);
    // stage entry point and user handler.
    const workdir = fs.mkdtempSync(path.join(os.tmpdir(), 'cdk-custom-resource-provider-handler-test-'));
    entrypoint.external.userHandlerIndex = path.join(workdir, 'index.js');
    fs.writeFileSync(entrypoint.external.userHandlerIndex, `exports.handler = ${userHandler.toString()};`);
    // do not include stack traces in failure responses so we can assert against them.
    entrypoint.external.includeStackTraces = false;
    // disable logging
    entrypoint.external.log = () => {
        return;
    };
    let actualResponse;
    entrypoint.external.sendHttpRequest = async (options, responseBody) => {
        assert(options.hostname === parsedResponseUrl.hostname, 'request hostname expected to be based on response URL');
        assert(options.path === parsedResponseUrl.path, 'request path expected to be based on response URL');
        assert(options.method === 'PUT', 'request method is expected to be PUT');
        actualResponse = responseBody;
    };
    await entrypoint.handler(req, {});
    if (!actualResponse) {
        throw new Error('no response sent to cloudformation');
    }
    return JSON.parse(actualResponse);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZWpzLWVudHJ5cG9pbnQudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm5vZGVqcy1lbnRyeXBvaW50LnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpQ0FBaUM7QUFDakMseUJBQXlCO0FBRXpCLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0IsMkJBQTJCO0FBQzNCLG1GQUFtRjtBQUVuRixRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO0lBQ2pDLFFBQVEsQ0FBQywyRUFBMkUsRUFBRSxHQUFHLEVBQUU7UUFFekYsSUFBSSxDQUFDLDRCQUE0QixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzVDLFFBQVE7WUFDUixNQUFNLFdBQVcsR0FBRyxTQUFTLENBQUMsRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztZQUV6RCxPQUFPO1lBQ1AsTUFBTSxRQUFRLEdBQUcsTUFBTSxhQUFhLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBQyxDQUFDLEVBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxrQkFBa0IsRUFBRSx1QkFBdUIsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUVoSCxPQUFPO1lBQ1AsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDM0MsTUFBTSxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBRXZFLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLG1CQUFtQixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ25DLFFBQVE7WUFDUixNQUFNLFdBQVcsR0FBRyxTQUFTLENBQUMsRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztZQUV6RCxPQUFPO1lBQ1AsTUFBTSxRQUFRLEdBQUcsTUFBTSxhQUFhLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBQyxDQUFDLEVBQUMsRUFB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LElBQUksY0FBYyxDQUFDO0lBQ25CLFVBQVUsQ0FBQyxRQUFRLENBQUMsZUFBZSxHQUFHLEtBQUssRUFBRSxPQUE2QixFQUFFLFlBQW9CLEVBQWlCLEVBQUU7UUFDakgsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEtBQUssaUJBQWlCLENBQUMsUUFBUSxFQUFFLHVEQUF1RCxDQUFDLENBQUM7UUFDakgsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEtBQUssaUJBQWlCLENBQUMsSUFBSSxFQUFFLG1EQUFtRCxDQUFDLENBQUM7UUFDckcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEtBQUssS0FBSyxFQUFFLHNDQUFzQyxDQUFDLENBQUM7UUFDekUsY0FBYyxHQUFHLFlBQVksQ0FBQztJQUNoQyxDQUFDLENBQUM7SUFFRixNQUFNLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQXVCLENBQUMsQ0FBQztJQUN2RCxJQUFJLENBQUMsY0FBYyxFQUFFO1FBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FBQztLQUN2RDtJQUVELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQW1ELENBQUM7QUFDdEYsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGFzc2VydCBmcm9tICdhc3NlcnQnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgaHR0cHMgZnJvbSAnaHR0cHMnO1xuaW1wb3J0ICogYXMgb3MgZnJvbSAnb3MnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIHVybCBmcm9tICd1cmwnO1xuaW1wb3J0ICogYXMgZW50cnlwb2ludCBmcm9tICcuLi8uLi9saWIvY3VzdG9tLXJlc291cmNlLXByb3ZpZGVyL25vZGVqcy1lbnRyeXBvaW50JztcblxuZGVzY3JpYmUoJ25vZGVqcyBlbnRyeXBvaW50JywgKCkgPT4ge1xuICBkZXNjcmliZSgnaGFuZGxlciByZXR1cm4gdmFsdWUgaXMgc2VudCBiYWNrIHRvIGNsb3VkZm9ybWF0aW9uIGFzIGEgc3VjY2VzcyByZXNwb25zZScsICgpID0+IHtcblxuICAgIHRlc3QoJ3BoeXNpY2FsIHJlc291cmNlIGlkIChyZWYpJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGNvbnN0IGNyZWF0ZUV2ZW50ID0gbWFrZUV2ZW50KHsgUmVxdWVzdFR5cGU6ICdDcmVhdGUnIH0pO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGludm9rZUhhbmRsZXIoY3JlYXRlRXZlbnQsIGFzeW5jIF8gPT4gKHsgUGh5c2ljYWxSZXNvdXJjZUlkOiAncmV0dXJuZWQtZnJvbS1oYW5kbGVyJyB9KSk7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5TdGF0dXMpLnRvRXF1YWwoJ1NVQ0NFU1MnKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5QaHlzaWNhbFJlc291cmNlSWQpLnRvRXF1YWwoJ3JldHVybmVkLWZyb20taGFuZGxlcicpO1xuXG4gICAgfSk7XG5cbiAgICB0ZXN0KCdkYXRhIChhdHRyaWJ1dGVzKScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBjb25zdCBjcmVhdGVFdmVudCA9IG1ha2VFdmVudCh7IFJlcXVlc3RUeXBlOiAnQ3JlYXRlJyB9KTtcblxuICAgICAgLy8gV0hFTlxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBpbnZva2VIYW5kbGVyKGNyZWF0ZUV2ZW50LCBhc3luYyBfID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBEYXRhOiB7XG4gICAgICAgICAgICBBdHRyaWJ1dGUxOiAnaGVsbG8nLFxuICAgICAgICAgICAgQXR0cmlidXRlMjoge1xuICAgICAgICAgICAgICBGb286IDExMTEsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH07XG4gICAgICB9KTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgZXhwZWN0KHJlc3BvbnNlLlN0YXR1cykudG9FcXVhbCgnU1VDQ0VTUycpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLlBoeXNpY2FsUmVzb3VyY2VJZCkudG9FcXVhbCgnPFJlcXVlc3RJZD4nKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5EYXRhKS50b0VxdWFsKHtcbiAgICAgICAgQXR0cmlidXRlMTogJ2hlbGxvJyxcbiAgICAgICAgQXR0cmlidXRlMjoge1xuICAgICAgICAgIEZvbzogMTExMSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgfSk7XG5cbiAgICB0ZXN0KCdubyBlY2hvJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGNvbnN0IGNyZWF0ZUV2ZW50ID0gbWFrZUV2ZW50KHsgUmVxdWVzdFR5cGU6ICdDcmVhdGUnIH0pO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGludm9rZUhhbmRsZXIoY3JlYXRlRXZlbnQsIGFzeW5jIF8gPT4gKHsgTm9FY2hvOiB0cnVlIH0pKTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgZXhwZWN0KHJlc3BvbnNlLlN0YXR1cykudG9FcXVhbCgnU1VDQ0VTUycpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLk5vRWNobykudG9FcXVhbCh0cnVlKTtcblxuICAgIH0pO1xuXG4gICAgdGVzdCgncmVhc29uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGNvbnN0IGNyZWF0ZUV2ZW50ID0gbWFrZUV2ZW50KHsgUmVxdWVzdFR5cGU6ICdDcmVhdGUnIH0pO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGludm9rZUhhbmRsZXIoY3JlYXRlRXZlbnQsIGFzeW5jIF8gPT4gKHsgUmVhc29uOiAnaGVsbG8sIHJlYXNvbicgfSkpO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBleHBlY3QocmVzcG9uc2UuU3RhdHVzKS50b0VxdWFsKCdTVUNDRVNTJyk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuUmVhc29uKS50b0VxdWFsKCdoZWxsbywgcmVhc29uJyk7XG5cbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnYW4gZXJyb3IgdGhyb3duIGJ5IHRoZSBoYW5kbGVyIGlzIHNlbnQgYXMgYSBmYWlsdXJlIHJlc3BvbnNlIHRvIGNsb3VkZm9ybWF0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3QgY3JlYXRlRXZlbnQgPSBtYWtlRXZlbnQoeyBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBpbnZva2VIYW5kbGVyKGNyZWF0ZUV2ZW50LCBhc3luYyBfID0+IHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigndGhpcyBpcyBhbiBlcnJvcicpO1xuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChyZXNwb25zZSkudG9FcXVhbCh7XG4gICAgICBTdGF0dXM6ICdGQUlMRUQnLFxuICAgICAgUmVhc29uOiAndGhpcyBpcyBhbiBlcnJvcicsXG4gICAgICBTdGFja0lkOiAnPFN0YWNrSWQ+JyxcbiAgICAgIFJlcXVlc3RJZDogJzxSZXF1ZXN0SWQ+JyxcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogJ0FXU0NESzo6Q3VzdG9tUmVzb3VyY2VQcm92aWRlckZyYW1ld29yazo6Q1JFQVRFX0ZBSUxFRCcsXG4gICAgICBMb2dpY2FsUmVzb3VyY2VJZDogJzxMb2dpY2FsUmVzb3VyY2VJZD4nLFxuICAgIH0pO1xuXG5cbiAgfSk7XG5cbiAgdGVzdCgncGh5c2ljYWwgcmVzb3VyY2UgaWQgY2Fubm90IGJlIGNoYW5nZWQgaW4gREVMRVRFJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3QgZXZlbnQgPSBtYWtlRXZlbnQoeyBSZXF1ZXN0VHlwZTogJ0RlbGV0ZScgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBpbnZva2VIYW5kbGVyKGV2ZW50LCBhc3luYyBfID0+ICh7XG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6ICdDaGFuZ2VkJyxcbiAgICB9KSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHJlc3BvbnNlKS50b0VxdWFsKHtcbiAgICAgIFN0YXR1czogJ0ZBSUxFRCcsXG4gICAgICBSZWFzb246ICdERUxFVEU6IGNhbm5vdCBjaGFuZ2UgdGhlIHBoeXNpY2FsIHJlc291cmNlIElEIGZyb20gXCJ1bmRlZmluZWRcIiB0byBcIkNoYW5nZWRcIiBkdXJpbmcgZGVsZXRpb24nLFxuICAgICAgU3RhY2tJZDogJzxTdGFja0lkPicsXG4gICAgICBSZXF1ZXN0SWQ6ICc8UmVxdWVzdElkPicsXG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6ICdBV1NDREs6OkN1c3RvbVJlc291cmNlUHJvdmlkZXJGcmFtZXdvcms6Ok1JU1NJTkdfUEhZU0lDQUxfSUQnLFxuICAgICAgTG9naWNhbFJlc291cmNlSWQ6ICc8TG9naWNhbFJlc291cmNlSWQ+JyxcbiAgICB9KTtcblxuXG4gIH0pO1xuXG4gIHRlc3QoJ0RFTEVURSBhZnRlciBDUkVBVEUgaXMgaWdub3JlZCB3aXRoIHN1Y2Nlc3MnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBldmVudCA9IG1ha2VFdmVudCh7XG4gICAgICBSZXF1ZXN0VHlwZTogJ0RlbGV0ZScsXG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6ICdBV1NDREs6OkN1c3RvbVJlc291cmNlUHJvdmlkZXJGcmFtZXdvcms6OkNSRUFURV9GQUlMRUQnLFxuICAgIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgaW52b2tlSGFuZGxlcihldmVudCwgYXN5bmMgXyA9PiB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2hhbmRsZXIgc2hvdWxkIG5vdCBiZSBjYWxsZWQnKTtcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3QocmVzcG9uc2UpLnRvRXF1YWwoe1xuICAgICAgU3RhdHVzOiAnU1VDQ0VTUycsXG4gICAgICBSZWFzb246ICdTVUNDRVNTJyxcbiAgICAgIFN0YWNrSWQ6ICc8U3RhY2tJZD4nLFxuICAgICAgUmVxdWVzdElkOiAnPFJlcXVlc3RJZD4nLFxuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiAnQVdTQ0RLOjpDdXN0b21SZXNvdXJjZVByb3ZpZGVyRnJhbWV3b3JrOjpDUkVBVEVfRkFJTEVEJyxcbiAgICAgIExvZ2ljYWxSZXNvdXJjZUlkOiAnPExvZ2ljYWxSZXNvdXJjZUlkPicsXG4gICAgfSk7XG5cbiAgfSk7XG59KTtcblxuZnVuY3Rpb24gbWFrZUV2ZW50KHJlcTogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50Pik6IEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnQge1xuICByZXR1cm4ge1xuICAgIExvZ2ljYWxSZXNvdXJjZUlkOiAnPExvZ2ljYWxSZXNvdXJjZUlkPicsXG4gICAgUmVxdWVzdElkOiAnPFJlcXVlc3RJZD4nLFxuICAgIFJlc291cmNlVHlwZTogJzxSZXNvdXJjZVR5cGU+JyxcbiAgICBSZXNwb25zZVVSTDogJzxSZXNwb25zZVVSTD4nLFxuICAgIFNlcnZpY2VUb2tlbjogJzxTZXJ2aWNlVG9rZW4+JyxcbiAgICBTdGFja0lkOiAnPFN0YWNrSWQ+JyxcbiAgICBSZXNvdXJjZVByb3BlcnRpZXM6IHtcbiAgICAgIFNlcnZpY2VUb2tlbjogJzxTZXJ2aWNlVG9rZW4+JyxcbiAgICAgIC4uLnJlcS5SZXNvdXJjZVByb3BlcnRpZXMsXG4gICAgfSxcbiAgICAuLi5yZXEsXG4gIH0gYXMgYW55O1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbnZva2VIYW5kbGVyKHJlcTogQVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudCwgdXNlckhhbmRsZXI6IGVudHJ5cG9pbnQuSGFuZGxlcikge1xuICBjb25zdCBwYXJzZWRSZXNwb25zZVVybCA9IHVybC5wYXJzZShyZXEuUmVzcG9uc2VVUkwpO1xuXG4gIC8vIHN0YWdlIGVudHJ5IHBvaW50IGFuZCB1c2VyIGhhbmRsZXIuXG4gIGNvbnN0IHdvcmtkaXIgPSBmcy5ta2R0ZW1wU3luYyhwYXRoLmpvaW4ob3MudG1wZGlyKCksICdjZGstY3VzdG9tLXJlc291cmNlLXByb3ZpZGVyLWhhbmRsZXItdGVzdC0nKSk7XG4gIGVudHJ5cG9pbnQuZXh0ZXJuYWwudXNlckhhbmRsZXJJbmRleCA9IHBhdGguam9pbih3b3JrZGlyLCAnaW5kZXguanMnKTtcbiAgZnMud3JpdGVGaWxlU3luYyhlbnRyeXBvaW50LmV4dGVybmFsLnVzZXJIYW5kbGVySW5kZXgsIGBleHBvcnRzLmhhbmRsZXIgPSAke3VzZXJIYW5kbGVyLnRvU3RyaW5nKCl9O2ApO1xuXG4gIC8vIGRvIG5vdCBpbmNsdWRlIHN0YWNrIHRyYWNlcyBpbiBmYWlsdXJlIHJlc3BvbnNlcyBzbyB3ZSBjYW4gYXNzZXJ0IGFnYWluc3QgdGhlbS5cbiAgZW50cnlwb2ludC5leHRlcm5hbC5pbmNsdWRlU3RhY2tUcmFjZXMgPSBmYWxzZTtcblxuICAvLyBkaXNhYmxlIGxvZ2dpbmdcbiAgZW50cnlwb2ludC5leHRlcm5hbC5sb2cgPSAoKSA9PiB7XG4gICAgcmV0dXJuO1xuICB9O1xuXG4gIGxldCBhY3R1YWxSZXNwb25zZTtcbiAgZW50cnlwb2ludC5leHRlcm5hbC5zZW5kSHR0cFJlcXVlc3QgPSBhc3luYyAob3B0aW9uczogaHR0cHMuUmVxdWVzdE9wdGlvbnMsIHJlc3BvbnNlQm9keTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgYXNzZXJ0KG9wdGlvbnMuaG9zdG5hbWUgPT09IHBhcnNlZFJlc3BvbnNlVXJsLmhvc3RuYW1lLCAncmVxdWVzdCBob3N0bmFtZSBleHBlY3RlZCB0byBiZSBiYXNlZCBvbiByZXNwb25zZSBVUkwnKTtcbiAgICBhc3NlcnQob3B0aW9ucy5wYXRoID09PSBwYXJzZWRSZXNwb25zZVVybC5wYXRoLCAncmVxdWVzdCBwYXRoIGV4cGVjdGVkIHRvIGJlIGJhc2VkIG9uIHJlc3BvbnNlIFVSTCcpO1xuICAgIGFzc2VydChvcHRpb25zLm1ldGhvZCA9PT0gJ1BVVCcsICdyZXF1ZXN0IG1ldGhvZCBpcyBleHBlY3RlZCB0byBiZSBQVVQnKTtcbiAgICBhY3R1YWxSZXNwb25zZSA9IHJlc3BvbnNlQm9keTtcbiAgfTtcblxuICBhd2FpdCBlbnRyeXBvaW50LmhhbmRsZXIocmVxLCB7fSBhcyBBV1NMYW1iZGEuQ29udGV4dCk7XG4gIGlmICghYWN0dWFsUmVzcG9uc2UpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ25vIHJlc3BvbnNlIHNlbnQgdG8gY2xvdWRmb3JtYXRpb24nKTtcbiAgfVxuXG4gIHJldHVybiBKU09OLnBhcnNlKGFjdHVhbFJlc3BvbnNlKSBhcyBBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVJlc3BvbnNlO1xufVxuIl19